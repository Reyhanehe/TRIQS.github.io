<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>An overview of the Monte Carlo class &mdash; TRIQS 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/triqs.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax/MathJax.js?config=default"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="top" title="TRIQS 1.0.0 documentation" href="../../../index.html" />
    <link rel="up" title="Tools for Monte Carlo" href="intro.html" />
    <link rel="next" title="Full reference" href="reference.html" />
    <link rel="prev" title="The Monte Carlo loop" href="loop.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
    <script src="../../../_static/cufon-yui.js" type="text/javascript"></script>
    <script src="../../../_static/spaceman.cufonfonts.js" type="text/javascript"></script>
    <script type="text/javascript">
      Cufon.replace('.triqs', { fontFamily: 'spaceman', hover: true }); 
    </script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>

  </head>
  <body>
<div class="pageheader">
  <ul>
    
    <li><a href="../../../install.html">Install</a></li>
    
    <li><a href="../../../documentation.html">Documentation</a></li>
    
    <li><a href="../../../applications.html">Applications</a></li>
    
    <li><a href="../../../issues.html">Issues</a></li>
    
    <li><a href="../../../about.html">About TRIQS</a></li>
    
  </ul>
  <div>
    <h1 style="padding:0; margin: 10px 0 0 0;"><a class="triqs" href="../../../index.html">triqs</a></h1>
    <span style="font-size: 14px; margin: 0px; padding: 0px;">a Toolbox for Research on Interacting Quantum Systems</span>
  </div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Full reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="loop.html" title="The Monte Carlo loop"
             accesskey="P">previous</a> |</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>

          <li><a href="../../../documentation.html" >Documentation</a> &raquo;</li>
          <li><a href="../contents.html" >C++</a> &raquo;</li>
          <li><a href="intro.html" accesskey="U">Tools for Monte Carlo</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">An overview of the Monte Carlo class</a><ul>
<li><a class="reference internal" href="#the-c-code-for-this-problem">The C++ code for this problem</a></li>
<li><a class="reference internal" href="#initializing-the-mpi">Initializing the MPI</a></li>
<li><a class="reference internal" href="#constructing-the-monte-carlo-simulation">Constructing the Monte Carlo simulation</a></li>
<li><a class="reference internal" href="#moves-and-measures">Moves and measures</a></li>
<li><a class="reference internal" href="#the-move-concept">The move concept</a></li>
<li><a class="reference internal" href="#the-measure-concept">The measure concept</a></li>
<li><a class="reference internal" href="#starting-the-monte-carlo-simulation">Starting the Monte Carlo simulation</a></li>
<li><a class="reference internal" href="#end-of-the-simulation-gathering-results">End of the simulation - gathering results</a></li>
<li><a class="reference internal" href="#writing-your-own-monte-carlo-simulation">Writing your own Monte Carlo simulation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="loop.html"
                        title="previous chapter">The Monte Carlo loop</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="reference.html"
                        title="next chapter">Full reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/reference/c++/mctools/overview.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="an-overview-of-the-monte-carlo-class">
<h1>An overview of the Monte Carlo class<a class="headerlink" href="#an-overview-of-the-monte-carlo-class" title="Permalink to this headline">¶</a></h1>
<p>In order to have a first overview of the main features of the <tt class="docutils literal"><span class="pre">mc_generic</span></tt>
class, let&#8217;s start with a concrete Monte Carlo code. We will consider maybe the
simplest problem ever: a single spin in a magnetic field <span class="math">\(h\)</span> at a
temperature <span class="math">\(1/\beta\)</span>. The Hamiltonian is simply:</p>
<div class="math">
\[\mathcal{H} = - h (n_\uparrow - n_\downarrow).\]</div>
<p>You want to compute the magnetization of this single spin. From statistical
mechanics it is clearly just</p>
<div class="math">
\[m = \frac{\exp(\beta h) - \exp(-\beta h)}{\exp(\beta h) + \exp(-\beta h)}\]</div>
<div class="section" id="the-c-code-for-this-problem">
<h2>The C++ code for this problem<a class="headerlink" href="#the-c-code-for-this-problem" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s see how we can get this result from a Monte Carlo simulation. Here is
a code that would do the job. Note that we put everything in one file here,
but obviously you would usually want to cut this into pieces for clarity:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;triqs/utility/callbacks.hpp&gt;</span>
<span class="cp">#include &lt;triqs/mc_tools/mc_generic.hpp&gt;</span>

<span class="c1">// the configuration: a spin, the inverse temperature, the external field</span>
<span class="k">struct</span> <span class="n">configuration</span> <span class="p">{</span>

  <span class="kt">int</span> <span class="n">spin</span><span class="p">;</span> <span class="kt">double</span> <span class="n">beta</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
  <span class="n">configuration</span><span class="p">(</span><span class="kt">double</span> <span class="n">beta_</span><span class="p">,</span> <span class="kt">double</span> <span class="n">h_</span><span class="p">)</span> <span class="o">:</span> <span class="n">spin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">beta</span><span class="p">(</span><span class="n">beta_</span><span class="p">),</span> <span class="n">h</span><span class="p">(</span><span class="n">h_</span><span class="p">)</span> <span class="p">{}</span>

<span class="p">};</span>


<span class="c1">// a move: flip the spin</span>
<span class="k">struct</span> <span class="n">flip</span> <span class="p">{</span>

  <span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config</span><span class="p">;</span>

  <span class="n">flip</span><span class="p">(</span><span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config_</span><span class="p">)</span> <span class="o">:</span> <span class="n">config</span><span class="p">(</span><span class="n">config_</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">double</span> <span class="n">attempt</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">spin</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">h</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">beta</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">double</span> <span class="n">accept</span><span class="p">()</span> <span class="p">{</span> <span class="n">config</span><span class="p">.</span><span class="n">spin</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">return</span> <span class="mf">1.0</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">reject</span><span class="p">()</span> <span class="p">{}</span>

<span class="p">};</span>

<span class="c1">// a measurement: the magnetization</span>
<span class="k">struct</span> <span class="n">compute_m</span> <span class="p">{</span>

  <span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Z</span><span class="p">,</span> <span class="n">M</span><span class="p">;</span>

  <span class="n">compute_m</span><span class="p">(</span><span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config_</span><span class="p">)</span> <span class="o">:</span> <span class="n">config</span><span class="p">(</span><span class="n">config_</span><span class="p">),</span> <span class="n">Z</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">M</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">accumulate</span><span class="p">(</span><span class="kt">double</span> <span class="n">sign</span><span class="p">)</span> <span class="p">{</span> <span class="n">Z</span> <span class="o">+=</span> <span class="n">sign</span><span class="p">;</span> <span class="n">M</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">spin</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">double</span> <span class="n">sum_Z</span><span class="p">,</span> <span class="n">sum_M</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">reduce</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">sum_Z</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">reduce</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">sum_M</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Magnetization: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sum_M</span> <span class="o">/</span> <span class="n">sum_Z</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

  <span class="c1">// initialize mpi</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">environment</span> <span class="n">env</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span> <span class="n">world</span><span class="p">;</span>

  <span class="c1">// greeting</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Isolated spin&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="c1">// prepare the MC parameters</span>
  <span class="kt">int</span> <span class="n">n_cycles</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">length_cycle</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">n_warmup_cycles</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">random_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">374982</span> <span class="o">+</span> <span class="n">world</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="mi">273894</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// construct a Monte Carlo loop</span>
  <span class="n">triqs</span><span class="o">::</span><span class="n">mc_tools</span><span class="o">::</span><span class="n">mc_generic</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">SpinMC</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">,</span> <span class="n">length_cycle</span><span class="p">,</span> <span class="n">n_warmup_cycles</span><span class="p">,</span>
                                             <span class="n">random_name</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">);</span>

  <span class="c1">// parameters of the model</span>
  <span class="kt">double</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">field</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>

  <span class="c1">// construct configuration</span>
  <span class="n">configuration</span> <span class="n">config</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>

  <span class="c1">// add moves and measures</span>
  <span class="n">SpinMC</span><span class="p">.</span><span class="n">add_move</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="s">&quot;flip move&quot;</span><span class="p">);</span>
  <span class="n">SpinMC</span><span class="p">.</span><span class="n">add_measure</span><span class="p">(</span><span class="n">compute_m</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="s">&quot;magnetization measure&quot;</span><span class="p">);</span>

  <span class="c1">// Run and collect results</span>
  <span class="n">SpinMC</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">triqs</span><span class="o">::</span><span class="n">utility</span><span class="o">::</span><span class="n">clock_callback</span><span class="p">(</span><span class="mi">600</span><span class="p">));</span>
  <span class="n">SpinMC</span><span class="p">.</span><span class="n">collect_results</span><span class="p">(</span><span class="n">world</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Let&#8217;s go through the different parts of this code. First we look
at <tt class="docutils literal"><span class="pre">main()</span></tt>.</p>
</div>
<div class="section" id="initializing-the-mpi">
<h2>Initializing the MPI<a class="headerlink" href="#initializing-the-mpi" title="Permalink to this headline">¶</a></h2>
<p>As you will see, the Monte Carlo class is completely MPI ready.  The first two
lines of the <tt class="docutils literal"><span class="pre">main()</span></tt> just initialize the MPI environment and declare a
communicator. The default communicator is <tt class="docutils literal"><span class="pre">WORLD</span></tt> which means that all the
nodes will be involved in the calculation:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">environment</span> <span class="n">env</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span> <span class="n">world</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="constructing-the-monte-carlo-simulation">
<h2>Constructing the Monte Carlo simulation<a class="headerlink" href="#constructing-the-monte-carlo-simulation" title="Permalink to this headline">¶</a></h2>
<p>The lines that follow, define the parameters of the Monte
Carlo simulation and construct a Monte Carlo object
called <tt class="docutils literal"><span class="pre">SpinMC</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="n">n_cycles</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">length_cycle</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n_warmup_cycles</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">random_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">374982</span> <span class="o">+</span> <span class="n">world</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="mi">273894</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">triqs</span><span class="o">::</span><span class="n">mc_tools</span><span class="o">::</span><span class="n">mc_generic</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">SpinMC</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">,</span> <span class="n">length_cycle</span><span class="p">,</span> <span class="n">n_warmup_cycles</span><span class="p">,</span>
                                           <span class="n">random_name</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">);</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">SpinMC</span></tt> is an instance of the <tt class="docutils literal"><span class="pre">mc_generic</span></tt> class. First of all, note
that you need to include the header <tt class="docutils literal"><span class="pre">&lt;triqs/mc_tools/mc_generic.hpp&gt;</span></tt> in
order to access the <tt class="docutils literal"><span class="pre">mc_generic</span></tt> class. The <tt class="docutils literal"><span class="pre">mc_generic</span></tt> class is a
template on the type of the Monte Carlo sign. Usually this will be either a
<tt class="docutils literal"><span class="pre">double</span></tt> or a <tt class="docutils literal"><span class="pre">complex&lt;double&gt;</span></tt>.</p>
<p>The first three parameters determine the length of the Monte Carlo cycles, the
number of measurements and the warmup length. The definition of these variables
has been detailed earlier in <a class="reference internal" href="loop.html#montecarloloop"><em>The Monte Carlo loop</em></a>.</p>
<p>The next two define the random number generator by giving its name in
<tt class="docutils literal"><span class="pre">random_name</span></tt> (an empty string means the default generator, i.e. the Mersenne
Twister) and the random seed in <tt class="docutils literal"><span class="pre">random_seed</span></tt>. As you see the seed is
different for all node with the use of <tt class="docutils literal"><span class="pre">world.rank()</span></tt>.</p>
<p>Finally, the last parameter sets the verbosity level. 0 means no output, 1 will
output the progress level for the current node and 2 additionally shows some
statistics about the simulation when you call <tt class="docutils literal"><span class="pre">collect_results</span></tt>. As you see,
we have put <tt class="docutils literal"><span class="pre">verbosity</span></tt> to 2 only for the master node and 0 for all the other
ones. This way the information will be printed only by the master.</p>
</div>
<div class="section" id="moves-and-measures">
<h2>Moves and measures<a class="headerlink" href="#moves-and-measures" title="Permalink to this headline">¶</a></h2>
<p>At this stage the basic structure of the Monte Carlo is in <tt class="docutils literal"><span class="pre">SpinMC</span></tt>. But we
now need to tell it what moves must be tried and what measures must be made.
This is done with:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">SpinMC</span><span class="p">.</span><span class="n">add_move</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="s">&quot;flip move&quot;</span><span class="p">);</span>
<span class="n">SpinMC</span><span class="p">.</span><span class="n">add_measure</span><span class="p">(</span><span class="n">compute_m</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="s">&quot;magnetization measure&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The method <tt class="docutils literal"><span class="pre">add_move</span></tt> expects a move and a name, while
<tt class="docutils literal"><span class="pre">add_measure</span></tt> expects a measure and a name. The name can be
anything, but different measures must have different names. In this example,
the move is an instance of the <tt class="docutils literal"><span class="pre">flip</span></tt> class and the measure an instance of
the <tt class="docutils literal"><span class="pre">compute_m</span></tt> class. These classes have been defined in the beginning of
the code and they have no direct connection with the <tt class="docutils literal"><span class="pre">mc_generic</span></tt> class (e.g.
they don&#8217;t have inheritance links with <tt class="docutils literal"><span class="pre">mc_generic</span></tt>).  Actually you are
almost completely free to design these classes as you want, <strong>as long as they
satisfy the correct concept</strong>.</p>
</div>
<div class="section" id="the-move-concept">
<h2>The move concept<a class="headerlink" href="#the-move-concept" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s go back to the beginning of the code and have a look at the <tt class="docutils literal"><span class="pre">flip</span></tt>
class which proposed a flip of the spin. The class is very short.  It has a
constructor which might define some class variables. But more importantly, it
has three member functions that any move <strong>must</strong> have: <tt class="docutils literal"><span class="pre">attempt</span></tt>, <tt class="docutils literal"><span class="pre">accept</span></tt> and
<tt class="docutils literal"><span class="pre">reject</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">flip</span> <span class="p">{</span>

  <span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config</span><span class="p">;</span>

  <span class="n">flip</span><span class="p">(</span><span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config_</span><span class="p">)</span> <span class="o">:</span> <span class="n">config</span><span class="p">(</span><span class="n">config_</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">double</span> <span class="n">attempt</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">spin</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">h</span><span class="o">*</span><span class="n">config</span><span class="p">.</span><span class="n">beta</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">double</span> <span class="n">accept</span><span class="p">()</span> <span class="p">{</span> <span class="n">config</span><span class="p">.</span><span class="n">spin</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">return</span> <span class="mf">1.0</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">reject</span><span class="p">()</span> <span class="p">{}</span>

<span class="p">};</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">attempt</span></tt> method is called by the Monte Carlo loop in order to try a new
move. The Monte Carlo class doesn&#8217;t care about what this trial is. All that
matters for the loop is the Metropolis ratio describing the transition to a new
proposed configuration. It is precisely this ratio that the <tt class="docutils literal"><span class="pre">attempt</span></tt> method is
expected to return:</p>
<div class="math">
\[T = \frac{P_{y,x} \rho(y)}{P_{x,y}\rho(x)}\]</div>
<p>In our example this ratio is</p>
<div class="math">
\[T = \frac{e^{\beta h -\sigma }}{e^{\beta h \sigma}} = e^{ - 2 \beta h \sigma }\]</div>
<p>With this ratio, the Monte Carlo loop decides whether this proposed move should
be rejected, or accepted. If the move is accepted, the Monte Carlo calls the
<tt class="docutils literal"><span class="pre">accept</span></tt> method of the move, otherwise it calls the <tt class="docutils literal"><span class="pre">reject</span></tt> method.  The
<tt class="docutils literal"><span class="pre">accept</span></tt> method should always return 1.0 unless you want to correct the sign
only when moves are accepted for performance reasons (this rather special case
is described in the <a class="reference internal" href="reference.html#montecarloref"><em>full reference</em></a>).  Note that the
return type of <tt class="docutils literal"><span class="pre">attempt</span></tt> and <tt class="docutils literal"><span class="pre">accept</span></tt> has to be the same as the template of the
Monte Carlo class.  In our example, nothing has to be done if the move is
rejected. If it is accepted, the spin should be flipped.</p>
</div>
<div class="section" id="the-measure-concept">
<h2>The measure concept<a class="headerlink" href="#the-measure-concept" title="Permalink to this headline">¶</a></h2>
<p>Just in the same way, the measures are expected to satisfy a concept.
Let&#8217;s look at <tt class="docutils literal"><span class="pre">compute_m</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">compute_m</span> <span class="p">{</span>

  <span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Z</span><span class="p">,</span> <span class="n">M</span><span class="p">;</span>

  <span class="n">compute_m</span><span class="p">(</span><span class="n">configuration</span> <span class="o">&amp;</span> <span class="n">config_</span><span class="p">)</span> <span class="o">:</span> <span class="n">config</span><span class="p">(</span><span class="n">config_</span><span class="p">),</span> <span class="n">Z</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">M</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">accumulate</span><span class="p">(</span><span class="kt">double</span> <span class="n">sign</span><span class="p">)</span> <span class="p">{</span> <span class="n">Z</span> <span class="o">+=</span> <span class="n">sign</span><span class="p">;</span> <span class="n">M</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">spin</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">double</span> <span class="n">sum_Z</span><span class="p">,</span> <span class="n">sum_M</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">reduce</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">sum_Z</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">reduce</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">sum_M</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Magnetization: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sum_M</span> <span class="o">/</span> <span class="n">sum_Z</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

<span class="p">};</span>
</pre></div>
</div>
<p>Here only two methods are expected, <tt class="docutils literal"><span class="pre">accumulate</span></tt> and <tt class="docutils literal"><span class="pre">collect_results</span></tt>.
The method <tt class="docutils literal"><span class="pre">accumulate</span></tt> is called every <tt class="docutils literal"><span class="pre">length_cycle</span></tt> Monte Carlo loops.
It takes one argument which is the current sign in the Monte Carlo simulation.
Here, we sum the sign in <tt class="docutils literal"><span class="pre">Z</span></tt> (the partition function) and the magnetization
in <tt class="docutils literal"><span class="pre">M</span></tt>. The other method <tt class="docutils literal"><span class="pre">collect_results</span></tt> is usually called just once at
the very end of the simulation, see below. It is meant to do the final
operations that are needed to have your result. Here it just needs to divide
<tt class="docutils literal"><span class="pre">M</span></tt> by <tt class="docutils literal"><span class="pre">Z</span></tt> and prints the result on the screen. Note that, it takes the MPI
communicator as an argument, meaning that you can easily do MPI operations
here.  This makes sense because the accumulation will have taken place
independently on all nodes and this is the good moment to gather the
information from all the nodes. This is why you see reduce operations on the
master node here.</p>
</div>
<div class="section" id="starting-the-monte-carlo-simulation">
<h2>Starting the Monte Carlo simulation<a class="headerlink" href="#starting-the-monte-carlo-simulation" title="Permalink to this headline">¶</a></h2>
<p>Well, at this stage we&#8217;re ready to launch our simulation. The moves
and measures have been specified, so all you need to do now is start
the simulation with:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">SpinMC</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">triqs</span><span class="o">::</span><span class="n">utility</span><span class="o">::</span><span class="n">clock_callback</span><span class="p">(</span><span class="mi">600</span><span class="p">));</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">start</span></tt> method takes two arguments. The first is the sign
of the very first <em>configuration</em> of the simulation. Because the
<tt class="docutils literal"><span class="pre">accept</span></tt> method only returns a ratio, this initial sign is used
to determine the sign of all generated configurations.</p>
<p>The second argument is used to decide if the simulation must be stopped for
some reason before it reaches the full number of cycles <tt class="docutils literal"><span class="pre">n_cycles</span></tt>. For
example, you might be running your code on a cluster that only allows for 1
hour simulations. In that case, you would want your simulation to stop, say
after 55 minutes, even if it didn&#8217;t manage to do the <tt class="docutils literal"><span class="pre">n_cycles</span></tt> cycles.</p>
<p>In practice, the second argument is a <tt class="docutils literal"><span class="pre">boost::function&lt;bool</span> <span class="pre">()&gt;</span></tt> which is
called at the end of every cycle. If it returns 0 the simulation goes on, if it
returns 1 the simulation stops. In this example, we used a function
<tt class="docutils literal"><span class="pre">clock_callback(600)</span></tt> which starts returning 1 after 600 seconds.  It is
defined in the header <tt class="file docutils literal"><span class="pre">&lt;triqs/utility/callbacks.hpp&gt;</span></tt>.  This way the
simulation will last at most 10 minutes.</p>
<p>Note that the simulation would end cleanly. The rest of the code can
safely gather results from the statistics that has been accumulated, even
if there have been less than <tt class="docutils literal"><span class="pre">n_cycles</span></tt> cycles.</p>
</div>
<div class="section" id="end-of-the-simulation-gathering-results">
<h2>End of the simulation - gathering results<a class="headerlink" href="#end-of-the-simulation-gathering-results" title="Permalink to this headline">¶</a></h2>
<p>When the simulation is over, it is time to gather the results.  This is done by
calling:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">SpinMC</span><span class="p">.</span><span class="n">collect_results</span><span class="p">(</span><span class="n">world</span><span class="p">);</span>
</pre></div>
</div>
<p>In practice this method goes through all the measurements that have been added
to the simulation and calls their <tt class="docutils literal"><span class="pre">collect_results</span></tt> member. As described
above, this does the final computations needed to get the result you are
interested in. It usually also saves or prints these results.</p>
</div>
<div class="section" id="writing-your-own-monte-carlo-simulation">
<h2>Writing your own Monte Carlo simulation<a class="headerlink" href="#writing-your-own-monte-carlo-simulation" title="Permalink to this headline">¶</a></h2>
<p>I hope that this simple example gave you an idea about how to use the
<tt class="docutils literal"><span class="pre">mc_generic</span></tt> class. In the next chapter we will address some more advanced
issues, but you should already be able to implement a Monte Carlo simulation of
your own. Maybe the only point that we haven&#8217;t addressed and which is useful,
is how to generate random numbers. Actually, as soon as you have generated an
instance of a <tt class="docutils literal"><span class="pre">mc_generic</span></tt> class, like <tt class="docutils literal"><span class="pre">SpinMC</span></tt> above, you automatically
have an acces to a random number generator with:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">triqs</span><span class="o">::</span><span class="n">mc_tools</span><span class="o">::</span><span class="n">random_generator</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">SpinMC</span><span class="p">.</span><span class="n">rng</span><span class="p">();</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">RNG</span></tt> is an instance of a <tt class="docutils literal"><span class="pre">random_generator</span></tt>. If you want to
generate a <tt class="docutils literal"><span class="pre">double</span></tt> number on the interval <span class="math">\([0,1[\)</span>, you just have to
call <tt class="docutils literal"><span class="pre">RNG()</span></tt>. By providing an argument to <tt class="docutils literal"><span class="pre">RNG</span></tt> you can generate integer
and real numbers on different intervals. This is described in detail in the
section <a class="reference internal" href="random.html#random"><em>Random number generator</em></a>.</p>
<p>That&#8217;s it! Why don&#8217;t you try to write your own Monte Carlo describing an
<em class="xref std std-ref">Ising chain in a field</em>! You will find the solution
in <a class="reference internal" href="ising.html#ising-solution"><em>this section</em></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Full reference"
             >next</a> |</li>
        <li class="right" >
          <a href="loop.html" title="The Monte Carlo loop"
             >previous</a> |</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>

          <li><a href="../../../documentation.html" >Documentation</a> &raquo;</li>
          <li><a href="../contents.html" >C++</a> &raquo;</li>
          <li><a href="intro.html" >Tools for Monte Carlo</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-2013, The TRIQS collaboration.
    </div>
  </body>
</html>